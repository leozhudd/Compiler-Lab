## 编译实验lab4：if语句与条件表达式

本次编译实验实现了if-else表达式的识别与分析，并且包括了条件表达式的实现。在这些功能的帮助下，我的编译器已经可以通过条件判断来实现基本控制流了，又是很大的一次进步。

首先是语法分析部分，本次依旧在语法上增加的内容不多，主要在stmt模块增加了if语句的表达，unaryOp中增加了“非”运算符号，并且增加了大小比较、相等比较和与或逻辑的运算符。同样的，通过ANTLR工具，可以很快的更新最新的语法规则并生成语法树。

在条件表达式的实现上，我主要使用了LLVM IR的`icmp`指令，配合eq/ne/sle/sgt等参数实现了大于小于和等于的表达式的求值，并将返回的结果保存到一个寄存器上。需要特别注意的是||和&&这两个逻辑运算符，我的实现方式是使用LLVM IR的`or`和`and`指令进行数值的按位与或运算，当成和普通的运算命令一样的处理。还有一种方法是通过br跳转来实现，即从左到右验证每一部分的真假，然后再跳转到相应的块中。这种方法或许和挑战实验的“短路求值”有关，等到后面再细究。

对于if-else语句的实现，其实也很简单，只需新建三个寄存器分别代表三个block，一个是条件为真执行的，一个是条件为假执行的，还有一个是执行结束后需要跳出到的。然后分别在这几部分中访问对应的stmt节点，最后添加一行br跳转语句跳转到if外继续执行即可。



最后是一个debug时遇到的坑点：

寄存器名称如果用纯数字（%1，%2...）会出问题，因为在实验手册中提到了：

> clang 默认生成的虚拟寄存器是按数字顺序命名的，LLVM 限制了所有数字命名的虚拟寄存器必须严格地从 0 开始递增，且每个函数参数和基本块都会占用一个编号。如果你不能确定怎样用数字命名虚拟寄存器，请使用字符串命名虚拟寄存器。

在我的程序中，前几次lab使用数字命名没有问题是因为没有跳转，只要顺序执行下来就行。但这次lab增加了if语句引入了跳转，导致了寄存器序号在程序执行时可能不连续。因此我的解决办法是把数字命名的寄存器改成用字母+数字命名的（%r1，%r2）即可。